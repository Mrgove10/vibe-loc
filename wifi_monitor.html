<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WiFi BSSID Monitor</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #00d4ff;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #16213e;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff4757;
            transition: background 0.3s;
        }

        .status-dot.connected {
            background: #2ed573;
            box-shadow: 0 0 10px #2ed573;
        }

        .timestamp {
            color: #888;
            font-size: 0.9em;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #16213e;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #00d4ff;
        }

        .stat-label {
            color: #888;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .network-table {
            width: 100%;
            background: #16213e;
            border-radius: 8px;
            overflow: hidden;
        }

        .network-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .network-table th,
        .network-table td {
            padding: 12px 15px;
            text-align: left;
        }

        .network-table th {
            background: #0f3460;
            color: #00d4ff;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 0.5px;
        }

        .network-table tr:not(:last-child) td {
            border-bottom: 1px solid #0f3460;
        }

        .network-table tr:hover td {
            background: rgba(0, 212, 255, 0.05);
        }

        .bssid {
            font-family: 'Courier New', monospace;
            color: #ffa502;
        }

        .signal-bar {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .signal-meter {
            width: 60px;
            height: 8px;
            background: #0f3460;
            border-radius: 4px;
            overflow: hidden;
        }

        .signal-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s, background 0.3s;
        }

        .signal-fill.excellent { background: #2ed573; }
        .signal-fill.good { background: #7bed9f; }
        .signal-fill.fair { background: #ffa502; }
        .signal-fill.weak { background: #ff6348; }
        .signal-fill.poor { background: #ff4757; }

        .channel {
            display: inline-block;
            background: #0f3460;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.9em;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state p {
            margin-top: 10px;
        }

        .config-panel {
            background: #16213e;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .config-panel label {
            display: block;
            margin-bottom: 5px;
            color: #888;
            font-size: 0.9em;
        }

        .config-panel input {
            width: 100%;
            padding: 10px;
            border: 1px solid #0f3460;
            border-radius: 4px;
            background: #1a1a2e;
            color: #eee;
            font-family: 'Courier New', monospace;
        }

        .config-panel input:focus {
            outline: none;
            border-color: #00d4ff;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .network-row {
            animation: fadeIn 0.3s ease-out;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>WiFi BSSID Monitor</h1>

        <div class="config-panel">
            <label for="topic">MQTT Topic:</label>
            <input type="text" id="topic" value="geoloc/wifi/bssids"
                   placeholder="Enter MQTT topic" onchange="reconnect()">
        </div>

        <div class="status-bar">
            <div class="status">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Connecting...</span>
            </div>
            <div class="timestamp" id="lastUpdate">Last update: --</div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="networkCount">0</div>
                <div class="stat-label">Networks Found</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgSignal">--</div>
                <div class="stat-label">Avg Signal</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="messageCount">0</div>
                <div class="stat-label">Messages Received</div>
            </div>
        </div>

        <div class="network-table">
            <table>
                <thead>
                    <tr>
                        <th>SSID</th>
                        <th>BSSID</th>
                        <th>Signal</th>
                        <th>Channel</th>
                    </tr>
                </thead>
                <tbody id="networkList">
                    <tr>
                        <td colspan="4" class="empty-state">
                            <div>Waiting for WiFi data...</div>
                            <p>Start the Python publisher script:</p>
                            <p><code>python3 wifi_mqtt_publisher.py</code></p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Paho MQTT JavaScript client -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.min.js"></script>

    <script>
        // MQTT Configuration
        const MQTT_BROKER = 'test.mosquitto.org';
        const MQTT_PORT = 8080;  // WebSocket port

        let client = null;
        let messageCount = 0;

        /**
         * Get signal strength class for styling
         */
        function getSignalClass(signal) {
            if (signal >= 80) return 'excellent';
            if (signal >= 60) return 'good';
            if (signal >= 40) return 'fair';
            if (signal >= 20) return 'weak';
            return 'poor';
        }

        /**
         * Update the UI with new network data
         */
        function updateNetworkList(data) {
            const tbody = document.getElementById('networkList');
            const networks = data.networks || [];

            // Update stats
            document.getElementById('networkCount').textContent = networks.length;
            messageCount++;
            document.getElementById('messageCount').textContent = messageCount;

            // Calculate average signal
            const signals = networks.filter(n => n.signal !== null).map(n => n.signal);
            const avgSignal = signals.length > 0
                ? Math.round(signals.reduce((a, b) => a + b, 0) / signals.length)
                : '--';
            document.getElementById('avgSignal').textContent = avgSignal !== '--' ? avgSignal + '%' : '--';

            // Update timestamp
            const timestamp = data.timestamp ? new Date(data.timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
            document.getElementById('lastUpdate').textContent = 'Last update: ' + timestamp;

            // Build table rows
            if (networks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="empty-state"><div>No networks found in scan</div></td></tr>';
                return;
            }

            // Sort by signal strength (strongest first)
            networks.sort((a, b) => (b.signal || 0) - (a.signal || 0));

            tbody.innerHTML = networks.map(net => {
                const signal = net.signal !== null ? net.signal : 0;
                const signalClass = getSignalClass(signal);
                const ssid = net.ssid || '<Hidden>';
                const bssid = net.bssid || 'N/A';
                const channel = net.channel !== null ? net.channel : '--';

                return '<tr class="network-row">' +
                    '<td>' + escapeHtml(ssid) + '</td>' +
                    '<td class="bssid">' + escapeHtml(bssid) + '</td>' +
                    '<td><div class="signal-bar">' +
                        '<div class="signal-meter">' +
                            '<div class="signal-fill ' + signalClass + '" style="width: ' + signal + '%"></div>' +
                        '</div>' +
                        '<span>' + signal + '%</span>' +
                    '</div></td>' +
                    '<td><span class="channel">' + channel + '</span></td>' +
                '</tr>';
            }).join('');
        }

        /**
         * Escape HTML to prevent XSS
         */
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        /**
         * Update connection status UI
         */
        function setStatus(connected, message) {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');

            if (connected) {
                dot.classList.add('connected');
            } else {
                dot.classList.remove('connected');
            }
            text.textContent = message;
        }

        /**
         * Connect to MQTT broker
         */
        function connectMQTT() {
            const topic = document.getElementById('topic').value;
            const clientId = 'webClient_' + Math.random().toString(16).substr(2, 8);

            // Disconnect existing client
            if (client && client.isConnected()) {
                client.disconnect();
            }

            setStatus(false, 'Connecting...');

            // Create MQTT client using WebSockets
            client = new Paho.Client(MQTT_BROKER, MQTT_PORT, clientId);

            // Set callback handlers
            client.onConnectionLost = function(responseObject) {
                setStatus(false, 'Disconnected: ' + responseObject.errorMessage);
                console.log('Connection lost:', responseObject.errorMessage);
                // Attempt to reconnect after 5 seconds
                setTimeout(connectMQTT, 5000);
            };

            client.onMessageArrived = function(message) {
                console.log('Message received on topic:', message.destinationName);
                try {
                    const data = JSON.parse(message.payloadString);
                    updateNetworkList(data);
                } catch (e) {
                    console.error('Failed to parse message:', e);
                }
            };

            // Connect to broker
            client.connect({
                onSuccess: function() {
                    setStatus(true, 'Connected to ' + MQTT_BROKER);
                    console.log('Connected to MQTT broker');

                    // Subscribe to topic
                    client.subscribe(topic, {
                        onSuccess: function() {
                            console.log('Subscribed to:', topic);
                        },
                        onFailure: function(err) {
                            console.error('Subscribe failed:', err);
                        }
                    });
                },
                onFailure: function(err) {
                    setStatus(false, 'Connection failed');
                    console.error('Connection failed:', err);
                    // Retry after 5 seconds
                    setTimeout(connectMQTT, 5000);
                },
                useSSL: false,
                timeout: 10
            });
        }

        /**
         * Reconnect with new topic
         */
        function reconnect() {
            messageCount = 0;
            connectMQTT();
        }

        // Start connection when page loads
        window.onload = connectMQTT;
    </script>
</body>
</html>
